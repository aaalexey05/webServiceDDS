{% extends "dds/base.html" %}
{% load currency %}
{% block title %}Записи ДДС{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Записи ДДС</h3>
  <a class="btn btn-primary" href="{% url 'record-create' %}">Новая запись</a>
  </div>

<div class="card mb-3">
  <div class="card-body">
<form class="row g-2" method="get">
  <div class="col-md-2">
    <label class="form-label">Дата с</label>
    <input type="date" class="form-control" name="date_from" value="{{ request.GET.date_from|default:'' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Дата по</label>
    <input type="date" class="form-control" name="date_to" value="{{ request.GET.date_to|default:'' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Статус</label>
    <select class="form-select" name="status">
      <option value="">Все</option>
      {% for s in statuses %}
        <option value="{{ s.id }}" {% if request.GET.status == s.id|stringformat:'s' %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Тип</label>
    <select class="form-select" name="cf_type" id="filter-type">
      <option value="">Все</option>
      {% for t in types %}
        <option value="{{ t.id }}" {% if request.GET.cf_type == t.id|stringformat:'s' %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Категория</label>
    <select class="form-select" name="category" id="filter-category">
      <option value="">Все</option>
      {% for c in categories %}
        <option data-type="{{ c.cf_type_id }}" value="{{ c.id }}" {% if request.GET.category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Подкатегория</label>
    <select class="form-select" name="subcategory" id="filter-subcategory">
      <option value="">Все</option>
      {% for sc in subcategories %}
        <option data-category="{{ sc.category_id }}" value="{{ sc.id }}" {% if request.GET.subcategory == sc.id|stringformat:'s' %}selected{% endif %}>{{ sc.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 d-flex gap-2 align-items-end mt-2">
    <button class="btn btn-primary" type="submit">Фильтровать</button>
    <a class="btn btn-outline-secondary" href="/">Сброс</a>
  </div>
</form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead><tr>
      <th>Дата</th><th>Статус</th><th>Тип</th><th>Категория</th><th>Подкатегория</th><th class="text-end">Сумма</th><th></th>
    </tr></thead>
    <tbody>
    {% for r in records %}
      <tr>
        <td>{{ r.created_at }}</td>
        <td><span class="badge text-bg-secondary">{{ r.status.name }}</span></td>
        <td><span class="badge text-bg-info">{{ r.cf_type.name }}</span></td>
        <td>{{ r.category.name }}</td>
        <td>{{ r.subcategory.name }}</td>
        <td class="text-end">{{ r.amount|rub }}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'record-update' r.id %}">Изменить</a>
          <a class="btn btn-sm btn-outline-danger" href="{% url 'record-delete' r.id %}">Удалить</a>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="7" class="text-center">Нет записей</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{% if records %}
  <div class="d-flex justify-content-end">
    <div class="fw-semibold">Итого: {{ page_obj.paginator.count }} шт., сумма: {{ total_amount|rub }}</div>
  </div>
{% endif %}

{% if page_obj %}
<nav class="mt-3" aria-label="Pagination">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
      {% if page_obj.has_previous %}
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">Назад</a>
      {% else %}
        <span class="page-link" aria-disabled="true" tabindex="-1">Назад</span>
      {% endif %}
    </li>
    <li class="page-item disabled"><span class="page-link">Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span></li>
    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
      {% if page_obj.has_next %}
        <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Вперёд</a>
      {% else %}
        <span class="page-link" aria-disabled="true" tabindex="-1">Вперёд</span>
      {% endif %}
    </li>
  </ul>
</nav>
{% endif %}

<script>
function filterCategoriesByType() {
  const t = document.getElementById('filter-type').value;
  const cats = document.querySelectorAll('#filter-category option');
  cats.forEach(o => {
    if (!o.value) return;
    o.hidden = t && o.dataset.type !== t;
  });
}
function filterSubcategoriesByCategory() {
  const c = document.getElementById('filter-category').value;
  const subs = document.querySelectorAll('#filter-subcategory option');
  subs.forEach(o => {
    if (!o.value) return;
    o.hidden = c && o.dataset.category !== c;
  });
}
document.getElementById('filter-type').addEventListener('change', e => { filterCategoriesByType(); filterSubcategoriesByCategory(); });
document.getElementById('filter-category').addEventListener('change', filterSubcategoriesByCategory);
filterCategoriesByType();
filterSubcategoriesByCategory();
</script>
{% endblock %}


